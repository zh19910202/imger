<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Chromeæ‰©å±•è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .diagnostic-item {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        .diagnostic-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .diagnostic-detail {
            font-size: 14px;
            margin-left: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            margin: 10px 0;
        }
        .solution {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Chromeæ‰©å±•è¯Šæ–­å·¥å…·</h1>
        <p style="text-align: center; color: #666;">æ£€æµ‹AnnotateFlow Assistantæ‰©å±•çš„åŠ è½½çŠ¶æ€å’ŒAPIå¯ç”¨æ€§</p>
        
        <button onclick="runDiagnostic()">ğŸš€ å¼€å§‹è¯Šæ–­</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
        
        <div id="results"></div>
        
        <div class="solution">
            <h3>ğŸ“‹ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3>
            <ol>
                <li><strong>æ‰©å±•æœªåŠ è½½ï¼š</strong>
                    <ul>
                        <li>æ‰“å¼€Chromeæ‰©å±•ç®¡ç†é¡µé¢ï¼š<code>chrome://extensions/</code></li>
                        <li>ç¡®ä¿"å¼€å‘è€…æ¨¡å¼"å·²å¼€å¯</li>
                        <li>ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©é¡¹ç›®æ–‡ä»¶å¤¹</li>
                    </ul>
                </li>
                <li><strong>æƒé™ä¸è¶³ï¼š</strong>
                    <ul>
                        <li>æ£€æŸ¥manifest.jsonä¸­çš„permissionsé…ç½®</li>
                        <li>ç¡®ä¿host_permissionsåŒ…å«ç›®æ ‡ç½‘ç«™</li>
                    </ul>
                </li>
                <li><strong>Content Scriptæœªæ³¨å…¥ï¼š</strong>
                    <ul>
                        <li>ç¡®ä¿åœ¨æ­£ç¡®çš„ç½‘ç«™ä¸Šæµ‹è¯•ï¼ˆhttps://qlabel.tencent.com/*ï¼‰</li>
                        <li>åˆ·æ–°é¡µé¢é‡æ–°åŠ è½½æ‰©å±•</li>
                    </ul>
                </li>
                <li><strong>Service Workeré—®é¢˜ï¼š</strong>
                    <ul>
                        <li>åœ¨æ‰©å±•ç®¡ç†é¡µé¢ç‚¹å‡»"æ£€æŸ¥è§†å›¾"æŸ¥çœ‹backgroundé¡µé¢</li>
                        <li>æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        function addResult(title, status, details) {
            const results = document.getElementById('results');
            const item = document.createElement('div');
            item.className = `diagnostic-item ${status}`;
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'diagnostic-title';
            titleDiv.textContent = title;
            
            const detailDiv = document.createElement('div');
            detailDiv.className = 'diagnostic-detail';
            detailDiv.innerHTML = details;
            
            item.appendChild(titleDiv);
            item.appendChild(detailDiv);
            results.appendChild(item);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        function runDiagnostic() {
            clearResults();
            
            // 1. æ£€æŸ¥Chromeå¯¹è±¡
            if (typeof chrome === 'undefined') {
                addResult(
                    'âŒ Chromeå¯¹è±¡ä¸å­˜åœ¨',
                    'error',
                    'è¿™é€šå¸¸è¡¨ç¤ºé¡µé¢ä¸åœ¨Chromeæ‰©å±•ç¯å¢ƒä¸­è¿è¡Œã€‚<br>è¯·ç¡®ä¿ï¼š<br>â€¢ åœ¨Chromeæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢<br>â€¢ æ‰©å±•å·²æ­£ç¡®å®‰è£…'
                );
                return;
            } else {
                addResult(
                    'âœ… Chromeå¯¹è±¡å­˜åœ¨',
                    'success',
                    'Chromeæ‰©å±•APIåŸºç¡€å¯¹è±¡å¯ç”¨'
                );
            }
            
            // 2. æ£€æŸ¥chrome.runtime
            if (!chrome.runtime) {
                addResult(
                    'âŒ chrome.runtimeä¸å¯ç”¨',
                    'error',
                    'Runtime APIä¸å¯ç”¨ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºï¼š<br>â€¢ æ‰©å±•æœªæ­£ç¡®åŠ è½½<br>â€¢ æƒé™é…ç½®é—®é¢˜<br>â€¢ åœ¨éæ‰©å±•ç¯å¢ƒä¸­è¿è¡Œ'
                );
            } else {
                addResult(
                    'âœ… chrome.runtimeå¯ç”¨',
                    'success',
                    `æ‰©å±•ID: ${chrome.runtime.id || 'æœªçŸ¥'}`
                );
            }
            
            // 3. æ£€æŸ¥æ‰©å±•ID
            if (chrome.runtime && chrome.runtime.id) {
                addResult(
                    'âœ… æ‰©å±•IDè·å–æˆåŠŸ',
                    'success',
                    `å½“å‰æ‰©å±•ID: <code>${chrome.runtime.id}</code>`
                );
            } else {
                addResult(
                    'âš ï¸ æ— æ³•è·å–æ‰©å±•ID',
                    'warning',
                    'è¿™å¯èƒ½è¡¨ç¤ºæ‰©å±•æœªæ­£ç¡®åŠ è½½æˆ–åœ¨é”™è¯¯çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ'
                );
            }
            
            // 4. æ£€æŸ¥å…³é”®API
            const apis = [
                { name: 'chrome.downloads', api: chrome.downloads },
                { name: 'chrome.storage', api: chrome.storage },
                { name: 'chrome.contextMenus', api: chrome.contextMenus },
                { name: 'chrome.tabs', api: chrome.tabs }
            ];
            
            apis.forEach(({name, api}) => {
                if (api) {
                    addResult(
                        `âœ… ${name}å¯ç”¨`,
                        'success',
                        `${name} APIå·²æ­£ç¡®åŠ è½½`
                    );
                } else {
                    addResult(
                        `âŒ ${name}ä¸å¯ç”¨`,
                        'error',
                        `${name} APIä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥manifest.jsonä¸­çš„permissionsé…ç½®`
                    );
                }
            });
            
            // 5. æ£€æŸ¥å½“å‰é¡µé¢URL
            const currentUrl = window.location.href;
            addResult(
                'ğŸ“ å½“å‰é¡µé¢ä¿¡æ¯',
                'info',
                `URL: <code>${currentUrl}</code><br>åè®®: ${window.location.protocol}<br>åŸŸå: ${window.location.hostname}`
            );
            
            // 6. æ£€æŸ¥æ˜¯å¦åœ¨ç›®æ ‡ç½‘ç«™
            if (currentUrl.includes('qlabel.tencent.com')) {
                addResult(
                    'âœ… åœ¨ç›®æ ‡ç½‘ç«™',
                    'success',
                    'å½“å‰åœ¨è…¾è®¯QLabelæ ‡æ³¨å¹³å°ï¼Œæ‰©å±•åº”è¯¥æ­£å¸¸å·¥ä½œ'
                );
            } else {
                addResult(
                    'âš ï¸ ä¸åœ¨ç›®æ ‡ç½‘ç«™',
                    'warning',
                    'AnnotateFlow Assistantä¸»è¦ä¸ºè…¾è®¯QLabelæ ‡æ³¨å¹³å°è®¾è®¡ï¼Œåœ¨å…¶ä»–ç½‘ç«™å¯èƒ½åŠŸèƒ½å—é™'
                );
            }
            
            // 7. å°è¯•å‘é€æ¶ˆæ¯åˆ°background script
            if (chrome.runtime && chrome.runtime.sendMessage) {
                chrome.runtime.sendMessage({action: 'ping'}, (response) => {
                    if (chrome.runtime.lastError) {
                        addResult(
                            'âŒ Background Scripté€šä¿¡å¤±è´¥',
                            'error',
                            `é”™è¯¯: ${chrome.runtime.lastError.message}<br>è¿™å¯èƒ½è¡¨ç¤ºbackground scriptæœªæ­£ç¡®åŠ è½½`
                        );
                    } else {
                        addResult(
                            'âœ… Background Scripté€šä¿¡æˆåŠŸ',
                            'success',
                            'Background scriptæ­£å¸¸å“åº”'
                        );
                    }
                });
            }
            
            // 8. æ£€æŸ¥manifestç‰ˆæœ¬
            if (chrome.runtime && chrome.runtime.getManifest) {
                const manifest = chrome.runtime.getManifest();
                addResult(
                    'ğŸ“‹ æ‰©å±•ä¿¡æ¯',
                    'info',
                    `åç§°: ${manifest.name}<br>ç‰ˆæœ¬: ${manifest.version}<br>Manifestç‰ˆæœ¬: ${manifest.manifest_version}`
                );
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œè¯Šæ–­
        window.addEventListener('load', () => {
            setTimeout(runDiagnostic, 500);
        });
    </script>
</body>
</html>